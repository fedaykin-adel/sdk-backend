# ===== builder =====
FROM rust:1.79-bullseye AS builder
WORKDIR /app

# deps do sqlx/openssl
RUN apt-get update && apt-get install -y pkg-config libssl-dev ca-certificates && update-ca-certificates

# cache de deps
COPY Cargo.toml Cargo.lock ./
# copie os manifests dos workspaces caso tenha (ex.: core lib)
COPY core ./core
RUN mkdir -p src && echo "fn main(){}" > src/main.rs
RUN cargo build --release || true

# agora o c√≥digo de fato
COPY . .
RUN cargo build --release

# ===== runtime =====
FROM debian:bullseye-slim
RUN apt-get update && apt-get install -y ca-certificates libssl1.1 && update-ca-certificates && \
    rm -rf /var/lib/apt/lists/*
WORKDIR /app
COPY --from=builder /app/target/release/backend /app/backend

ENV RUST_LOG=info
ENV PORT=8080
EXPOSE 8080

CMD ["/app/backend"]